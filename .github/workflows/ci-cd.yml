name: CI/CD Pipeline
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r docker/requirements.txt
    - name: Run tests
      run: |
        python -m pytest tests/ --cov=src --cov-report=term-missing
    - name: Coverage check
      run: |
        python -m pytest tests/ --cov=src --cov-fail-under=67

  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
    - uses: actions/checkout@v4
    - name: Set up Minikube
      uses: medyagh/setup-minikube@v0.0.16
      with:
        minikube-version: 'latest'
        kubernetes-version: 'v1.25.0'
        driver: 'docker'
        memory: '4096mb'
        cpus: '2'
    
    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.25.0'
    
    - name: Configure kubectl
      run: |
        mkdir -p $HOME/.kube
        minikube update-context
        kubectl config use-context minikube
    
    - name: Build Docker images in Minikube
      run: |
        eval $(minikube docker-env)
        docker build -f docker/Dockerfile.train -t ml-train:latest .
        docker build -f docker/Dockerfile.serve -t ml-serve:latest .
    
    - name: Install Argo Workflows
      run: |
        kubectl create namespace argo || true
        kubectl apply -n argo -f https://github.com/argoproj/argo-workflows/releases/download/v3.4.6/install.yaml
        kubectl wait --for=condition=available --timeout=300s deployment/argo-server -n argo
    
    - name: Install Argo CLI (Fixed)
      run: |
        # Download and verify the Argo CLI
        curl -sLO https://github.com/argoproj/argo-workflows/releases/download/v3.4.6/argo-linux-amd64.gz
        gunzip argo-linux-amd64.gz
        chmod +x argo-linux-amd64
        sudo mv argo-linux-amd64 /usr/local/bin/argo
        
        # Verify installation
        argo version 
    
    - name: Create ServiceAccount and RBAC
      run: |
        # Create service account for Argo workflows
        kubectl create serviceaccount argo -n argo || true
        
        # Create role binding for the service account
        kubectl create rolebinding argo-binding \
          --clusterrole=argo-role \
          --serviceaccount=argo:argo \
          -n argo || true
    
    - name: Trigger Argo Workflow
      run: |
        # Submit the workflow with proper error handling
        if argo submit ci-cd/argo-workflows/training-pipeline.yaml -n argo --serviceaccount argo; then
          echo "Workflow submitted successfully"
        else
          echo "Failed to submit workflow"
          exit 1
        fi